---
title: "K19"
author: "Michelle Boyce"
date: "02/04/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(splines)
library(Hmisc)
library(formattable)
```

```{r}
get_dataset <- function() {
  data_root <- "/Users/susy/workbench/K19/COVID-19/csse_covid_19_data/csse_covid_19_daily_reports/"
  data_files <- Sys.glob(paste(data_root,"*.csv",sep=""))
  
  # reference list
  header_hist = list(
    '01-22-2020'=list('Province.State','Country.Region','Last.Update','Confirmed','Deaths','Recovered'),
    '03-01-2020'=list('Province.State','Country.Region','Last.Update','Confirmed','Deaths','Recovered','Latitude','Longitude'),
    '03-22-2020'=list('FIPS','Admin2','Province_State','Country_Region','Last_Update','Lat','Long_','Confirmed','Deaths','Recovered','Active','Combined_Key')
  )

  df <- data.frame(
    date=character(),
    last_update=character(),
    lat=numeric(),
    long=numeric(),
    province_state=character(),
    country_region=character(),
    confirmed=numeric(),
    deaths=numeric(),
    recovered=numeric(),
    active=numeric(),
    stringsAsFactors = FALSE
  )
  b_flag <- 0
  for (data_file in data_files) {
    time_stamp <- sub(".csv","",sub(data_root,"",data_file))
    time_stamp <- as.character.Date(time_stamp)
    datum <- read.csv(data_file)
    if (time_stamp=='03-01-2020') {
      b_flag <- 1
    } else if (time_stamp=='03-22-2020') {
      b_flag <- 2
    }
    rows <- dim(datum)[1]
    time_stamps <- rep(time_stamp,rows)
    if (b_flag==0) {
      df <- rbind(df,data.frame(
        date=time_stamps,
        last_update=datum[['Last.Update']],
        lat=rep(NA,rows),
        long=rep(NA,rows),
        province_state=datum[['Province.State']],
        country_region=datum[['Country.Region']],
        confirmed=datum[['Confirmed']],
        deaths=datum[['Deaths']],
        recovered=datum[['Recovered']],
        active=rep(NA,rows),
        stringsAsFactors = FALSE
      ))
    } else if (b_flag==1) {
      df <- rbind(df,data.frame(
        date=time_stamps,
        last_update=datum[['Last.Update']],
        lat=datum[['Latitude']],
        long=datum[['Longitude']],
        province_state=datum[['Province.State']],
        country_region=datum[['Country.Region']],
        confirmed=datum[['Confirmed']],
        deaths=datum[['Deaths']],
        recovered=datum[['Recovered']],
        active=rep(NA,rows),
        stringsAsFactors = FALSE
      ))
    } else { # b_flag > 1
      df <- rbind(df,data.frame(
        date=time_stamps,
        last_update=datum[['Last_Update']],
        lat=datum[['Lat']],
        long=datum[['Long_']],
        province_state=datum[['Province_State']],
        country_region=datum[['Country_Region']],
        confirmed=datum[['Confirmed']],
        deaths=datum[['Deaths']],
        recovered=datum[['Recovered']],
        active=datum[['Active']],
        stringsAsFactors = FALSE
      ))
    }
  }
  df$confirmed[is.na(df$confirmed)] <- 0
  df$deaths[is.na(df$deaths)]       <- 0
  df$recovered[is.na(df$recovered)] <- 0
  df
}
df <- get_dataset()


plt_province_stats <- function(df) {
  time_stamp <- df$date[[length(df$date)]]
  provinces <- c('Nova Scotia','Prince Edward Island','New Brunswick','Quebec','Ontario','Manitoba','British Columbia')
  for (province in provinces) {
    png(gsub(" ","_",sprintf("plts/canada/K19_%s_Confirmed.png",province)), width=700, height=432)
    print(sprintf("plts/canada/K19_%s_Outcomes.png",province))
    pstats <- df[(df$province_state==province),]
    pstats <- pstats[(pstats$date > "03-12-2020"),]
    plot(as.Date(pstats$date,"%m-%d-%Y"),pstats$confirmed,type='b',xaxs='i',panel.first=grid(),
         xlab="Days",
         ylab=paste("Outcomes"),
         main=paste(province,"K19 Stats as of",time_stamp),
         log='y',
         cex=.7,
         pch=20
    )
    lines(as.Date(pstats$date,"%m-%d-%Y"),pstats$recovered,col='blue',type='b',cex=.7,pch=20)
    lines(as.Date(pstats$date,"%m-%d-%Y"),pstats$deaths,col='red',type='b',cex=.7,pch=20)
    legend("topleft",
         legend=c('Confirmed','Recovered','Deaths'),
         cex=.7,
         pch=20,
         col=c('black','blue','red'),
         lty=1
    )
    dev.off()
  }
}

plt_prov_stats <- function(df) {
  #provinces <- list('Quebec','Ontario','Manitoba','British Columbia')
  datum <- data.frame(
    province=c('Quebec','Ontario','Manitoba','Saskatchewan','British Columbia','Alberta'),
    color=c("red","blue","black","orange","brown","purple"),
    stringsAsFactors = FALSE
  )
  dates <- unique(df$date)
  zeros <- rep(0,length(dates))
  strs <- rep('',length(dates))
  dc <- data.frame(
    date=character(),
    province=character(),
    confirmed=numeric(),
    deaths=numeric(),
    recovered=numeric(),
    stringsAsFactors = FALSE
  )
  for (date in unique(df$date)) {
    sd <- df[(df$date==date),]
    for (province in datum$province){
      pstat <- sd[(sd$province_state==province),]
      if (dim(pstat)[1] > 0) {
        dc[nrow(dc)+1,] = list(as.character.Date(date),province,pstat$confirmed,pstat$deaths,pstat$recovered)
      } else {
        dc[nrow(dc)+1,] <- list(as.character.Date(date),province,NA,NA,NA)
      }
    }
  }
  dc['recovery'] <- dc$recovered*100.0/dc$confirmed
  dc <- dc[(dc$date > "03-12-2020"),]
  first <- TRUE
  png("plts/canada/K19_Major_Canada_Province_Stats.png", width=700, height=432)
  for (province in datum$province) {
    if (first) {
      plot(
        as.Date(dc[(dc$province==province),]$date,"%m-%d-%Y"),dc[(dc$province==province),]$confirmed,
        xaxs='i',
        ylim=c(min(dc$confirmed,na.rm=TRUE),max(dc$confirmed,na.rm=TRUE)),
        xlab="Days",
        ylab='Confirmed (Log Scale)',
        main=paste('Canada K19 Stats from John Hopkins as of',max(dc$date)),
        type='b',
        cex=.7,
        pch=20,
        col=datum[(datum$province==province),]$color,
        panel.first=grid(),
        log='y'
      )
      first <- FALSE
    } else {
      points(as.Date(dc[(dc$province==province),]$date,"%m-%d-%Y"),dc[(dc$province==province),]$confirmed,type='b',cex=.7,pch=20,col=datum[(datum$province==province),]$color)
    }
  }
  legend("topleft",
         legend=datum$province,
         cex=.7,
         pch=20,
         col=datum$color,
         lty=1
  )
  dev.off()
}


plt_canada_stats <- function(df) {
  time_stamp <- df$date[[length(df$date)]]
  canada <- df[(df$country_region=='Canada'),]
  # https://stackoverflow.com/questions/1660124/how-to-sum-a-variable-by-group
  png("plts/canada/K19_Canada_Stats.png", width=700, height=432)
  ac <- aggregate(canada$confirmed,by=list(date=canada$date),FUN=sum)
  plot(as.Date(ac$date,"%m-%d-%Y"),ac$x,type='b',xaxs='i',panel.first=grid(),cex=.7,pch=20,col="blue",
       xlab="Days",
       ylab="Confirmed (Log Scale)",
       main=paste("Canada K19 Stats as of",time_stamp),log="y")
  ad <- aggregate(canada$deaths,by=list(date=canada$date),FUN=sum)
  points(as.Date(ad$date,"%m-%d-%Y"),ad$x,type='b',cex=.7,pch=20,col="red")
  legend("topleft",legend=c('Confirmed','Deaths'),cex=.7,pch=20,col=c('blue','red'),lty=1)
  dev.off()
}

plt_province_stats(df)
plt_canada_stats(df)
plt_prov_stats(df)


dw <- data.frame(
  date=unique(df$date),
  confirmed=aggregate(df$confirmed,by=list(date=df$date),FUN=sum)$x,
  deaths=aggregate(df$deaths,by=list(date=df$date),FUN=sum)$x,
  recovered=aggregate(df$recovered,by=list(date=df$date),FUN=sum)$x,
  stringsAsFactors = FALSE
)
dw['recovery_rate'] <- dw$recovered*100.0/dw$confirmed
dw['death_rate'] <- dw$deaths*100.0/dw$confirmed
dw['total_rate'] <- (dw$recovered+dw$deaths)*100.0/dw$confirmed

df_country <- function(Country) {
  dfc <- data.frame(
    date=unique(df[(df$country_region==Country),]$date),
    confirmed=aggregate(df[(df$country_region==Country),]$confirmed,by=list(date=df[(df$country_region==Country),]$date),FUN=sum)$x,
    deaths=aggregate(df[(df$country_region==Country),]$deaths,by=list(date=df[(df$country_region==Country),]$date),FUN=sum)$x,
    recovered=aggregate(df[(df$country_region==Country),]$recovered,by=list(date=df[(df$country_region==Country),]$date),FUN=sum)$x,
    stringsAsFactors = FALSE
  )
  dfc['recovery_rate'] <- dfc$recovered*100 / dfc$confirmed
  dfc
}

get_recovery_rates <- function() {
  countries = c(
    'US','Spain','Italy','France','Germany','China','Iran','UK','Canada','Barbados','Jamaica',
    'Turkey','Switzerland','Belgium','Netherlands','Brazil','Austria','Portugal','South Korea',
    'Israel','Sweden','Australia','Norway','Ireland','India','Chile','Russia','Denmark','Czechia',
    'Poland','Malaysia','Japan','Philippines','Ecuador','Peru','Luxembourg')
  global_recoveries <- c()
  local_recoveries <- c()
  for (country in countries) {
    rc <- df_country(country)
    global_recoveries <- c(global_recoveries,rc$recovery_rate[nrow(rc)]*rc$confirmed[nrow(rc)]/dw$confirmed[nrow(dw)])
    local_recoveries <- c(local_recoveries,rc$recovery_rate[nrow(rc)])
  }
  rr <- data.frame(
    country=countries,
    global_recovery_rate=global_recoveries,
    local_recovery_rate=local_recoveries,
    stringsAsFactors = FALSE
  )
  rr[order(rr$global_recovery_rate,decreasing=TRUE),]
}
recovery_rates <- get_recovery_rates()


rr_str <- c()
chop <- 0.3
reduced_recovery_rates <- recovery_rates[(recovery_rates$global_recovery_rate>chop),]
for (idx in 1:nrow(reduced_recovery_rates)) {
  rr_str <- c(rr_str,sprintf("%s: %.1f%%",reduced_recovery_rates$country[idx],reduced_recovery_rates$global_recovery_rate[idx]))
}
rr_str <- c(rr_str,sprintf("[Global: %.1f%%]",sum(dw$recovery_rate[nrow(dw)])))

rrr_str <- c()
rrr <- recovery_rates[(order(recovery_rates$local_recovery_rate,decreasing = TRUE)),]
rrr <- rrr[(rrr$local_recovery_rate>5),]
for (idx in 1:nrow(rrr)) {
  rrr_str <- c(rrr_str,sprintf("%s: %.1f%%",rrr$country[idx],rrr$local_recovery_rate[idx]))
}
rrr_str <- c(rrr_str,sprintf("[Global: %.1f%%]",sum(dw$recovery_rate[nrow(dw)])))
#for (output in rrr_str) {cat(output,"\n")}

p_order <- 27
x <- seq(length(dw$recovery_rate))
y <- dw$recovery_rate
model <- lm(y ~ poly(x,p_order))
png("plts/K19_World_Outcome_Rates.png", width=700, height=432)
plot(
     as.Date(dw$date,"%m-%d-%Y"),
     dw$death_rate,
     xlab = 'Days',
     ylab='% Outcome Rates',
     ylim=c(0,100),
     main=paste('Global K19 Case Outcome Rates as of',df$date[[length(df$date)]]),
     # https://stackoverflow.com/questions/38594177/changing-date-time-format-in-r
     #main=paste('Global K19 Case Outcome Rates as of',as.POSIXct(as.Date(df$date[[length(df$date)]],"%m-%d-%Y"), format="%m-%d-%Y")),
     type='l',
     xaxs='i',
     yaxs='i',
     col='red',
     panel.first=grid()
)#strptime(as.Date(dw$date,"%m-%d-%Y"), format="%mon %d, %y")
points(as.Date(dw$date,"%m-%d-%Y"),dw$death_rate,cex=.7,pch=20,col='red')
points(as.Date(dw$date,"%m-%d-%Y"),fitted(model),type='l',col='blue')
points(as.Date(dw$date,"%m-%d-%Y"),dw$recovery_rate,cex=.7,pch=20,col='blue')
x <- seq(length(dw$total_rate))
y <- dw$total_rate
model <- lm(y ~ poly(x,p_order))
points(as.Date(dw$date,"%m-%d-%Y"),fitted(model),type='l',col="darkgrey")
minor.tick(nx=0,ny=2,tick.ratio=0.5)
legend("topleft",
       #title="Global Case Outcome Rates",
       legend=c(
           "Recovery_Rate = World_Recovered / World_Confirmed",
           "Death_Rate      = World_Deaths / World_Confirmed",
           "Total_Rate*      = Recovery_Rate + Death_Rate",
           sprintf("World_Confirmed: %s",as.character(comma(dw$confirmed[nrow(dw)],format="d")))
           #"*As the world recovers, the Total_Rate approaches 100%."
       ),
       cex=.7,
       pch=c(20,20,NA,NA),
       col=c("blue","red","darkgrey",NA),
       lty=1
)
dr <- sum(dw$recovery_rate[nrow(dw)])-sum(dw$recovery_rate[nrow(dw)-1])
dra <- if(dr>0) {"\u2191"} else if (dr==0) {"\u2195"} else {"\u2193"}
dd <- sum(dw$death_rate[nrow(dw)])-sum(dw$death_rate[nrow(dw)-1])
dda <- if(dd>0) {"\u2191"} else if (dd==0) {"\u2195"} else {"\u2193"}
dt <- sum(dw$total_rate[nrow(dw)])-sum(dw$total_rate[nrow(dw)-1])
dta <- if(dt>0) {"\u2191"} else if (dt==0) {"\u2195"} else {"\u2193"}
#op <- par(famliy="Courier")
legend("topright",bty='n',
    legend=c(
      sprintf("Recovered: %.2f%% %s %.2f%%",sum(dw$recovery_rate[nrow(dw)]),dra,dr),
      sprintf("Deaths: %.2f%% %s %.2f%%",sum(dw$death_rate[nrow(dw)]),dda,dd),
      sprintf("Total: %.2f%% %s %.2f%%",sum(dw$total_rate[nrow(dw)]),dta,dt)
    ),
    text.col=c("blue","red","darkgrey")
)
#par(op)
#legend("topright",bty='n',title=sprintf("Recovery_Rate Breakdown (>%s%%)",chop),cex=.7,legend=rr_str,text.col="blue")
#text(as.Date(dw$date,"%m-%d-%Y")[1],69.5,
#     paste("Notes: The Total_Rate should approach 100%, as the world recovers.",
#           "These curves should remain fairly unchanged when adjusted for True",
#           "Cases, due to the ratios. They should also remain relatively unchanged",
#           "due to inaccuracies in reporting, due to source variation.",sep="\n"),
#     cex=0.6,pos=4)
remove(x)
remove(y)
dev.off()

#TO-DO: https://plotly.com/r/filled-area-plots/
```
